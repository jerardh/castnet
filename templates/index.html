<!DOCTYPE html>
<html>
<head>
    <title>CastNet</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<h2>ğŸ¬ CastNet â€“ Smart Actor Recommendation</h2>

<form method="POST" id="mainForm">

    <label>Movie Plot</label>
    <textarea name="plot" id="plotInput" rows="4" required>
{{ request.form.get('plot','') }}</textarea>

    <div id="characters-container"></div>

    <button type="button" onclick="addCharacterCard()">â• Add Character</button>

    <br><br>

    <button type="submit" formaction="/predict">ğŸ¯ Get Actor Suggestions</button>
    <button type="submit" formaction="/plot_similarity">ğŸ“– Find Similar Plots</button>

</form>

{% if results %}
<hr>
<h2>ğŸ¬ Casting Results</h2>

{% for char, actors in results.items() %}
<div class="results">
    <h3>ğŸ­ {{ char }}</h3>

    {% if actors %}
        {% for row in actors %}
        <div class="actor-card tooltip">

            <div class="actor-name">{{ row.actor_name }}</div>
            <div class="meta">ğŸ‘¤ Gender: {{ row.gender }}</div>
            <div class="meta">ğŸ‚ Age Group: {{ row.age_group }}</div>

            <div class="similarity-container">
                <div class="similarity-label">
                    Match: {{ (row.similarity * 100) | round(1) }}%
                </div>
                <div class="similarity-bar-bg">
                    <div class="similarity-bar-fill"
                         style="width: {{ (row.similarity * 100) | round(1) }}%;">
                    </div>
                </div>
            </div>

            <div class="tooltip-text">
                <strong>Why this actor?</strong><br>
                ğŸ¬ Similar Movie: {{ row.movie_name }}<br>
                ğŸ­ Similar Character: {{ row.character_name }}
            </div>

        </div>
        {% endfor %}
    {% else %}
        <p class="no-result">âš ï¸ No matching actors found for this character.</p>
    {% endif %}
</div>
{% endfor %}
{% endif %}

<script>
let characterCount = 0;

// Restore characters after POST
{% for key, val in request.form.items() %}
    {% if key.startswith("char_desc_") %}
        addCharacterCard(
            "{{ val }}",
            "{{ request.form.get('gender_' + key.split('_')[-1], '') }}",
            "{{ request.form.get('age_' + key.split('_')[-1], '') }}"
        );
    {% endif %}
{% endfor %}

// If no characters (first load)
if (characterCount === 0) {
    addCharacterCard();
}

function addCharacterCard(desc="", gender="", age="") {
    characterCount++;

    const container = document.getElementById("characters-container");

    const div = document.createElement("div");
    div.className = "character-card";
    div.id = `char-card-${characterCount}`;

    div.innerHTML = `
        <h3>ğŸ­ Character ${characterCount}
            <button type="button" onclick="removeCharacterCard(${characterCount})">âŒ</button>
        </h3>

        <label>Description</label>
        <textarea name="char_desc_${characterCount}" rows="2" required>${desc}</textarea>

        <label>Gender</label>
        <select name="gender_${characterCount}">
            <option value="">Any</option>
            <option value="male" ${gender==="male"?"selected":""}>Male</option>
            <option value="female" ${gender==="female"?"selected":""}>Female</option>
        </select>

        <label>Age Group</label>
        <select name="age_${characterCount}">
            <option value="">Any</option>
            <option value="20-30" ${age==="20-30"?"selected":""}>20-30</option>
            <option value="30-40" ${age==="30-40"?"selected":""}>30-40</option>
            <option value="40-50" ${age==="40-50"?"selected":""}>40-50</option>
            <option value="60+" ${age==="60+"?"selected":""}>60+</option>
        </select>
    `;

    container.appendChild(div);
}

function removeCharacterCard(num) {
    const card = document.getElementById(`char-card-${num}`);
    if (card) card.remove();
}
</script>

</body>
</html>